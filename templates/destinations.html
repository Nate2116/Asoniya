{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Explore popular destinations in Ethiopia with Asoniya Platform. Discover Addis Ababa, Lalibela, and Bishoftu with ease.">
    <meta name="keywords" content="Ethiopia, travel, tourism, Addis Ababa, Lalibela, Bishoftu, destinations, attractions">
    <title>Asoniya Platform - Destinations</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/datepicker.css' %}">
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
</head>
<body>
    {% include 'components/header.html' %}

    <section class="visit-duration py-5">
        <div class="container">
            <div class="calendar-container">
                <div class="calendar-header">
                    <h2>Plan Your Ethiopian Adventure</h2>
                    <p class="calendar-subtitle">Choose the perfect dates for your journey</p>
                </div>
                <div class="calendar-body">
                    <div class="row justify-content-center">
                        <div class="col-md-8">
                            <div class="date-picker-wrapper">
                                <div class="date-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <input type="text" class="form-control custom-datepicker" id="visit-duration" placeholder="Select your travel dates...">
                            </div>
                            <div class="calendar-help-text">
                                <p><i class="fas fa-info-circle"></i> The best time to visit Ethiopia is between October and March (dry season)</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="destinations py-5">
        <div class="container">
            <h2 class="text-center mb-4">Popular Destinations</h2>
            <p class="text-center text-muted mb-5">Select destinations to explore their attractions</p>
            <div class="row">
                {% for dest in destinations %}
                <div class="col-md-4 mb-4">
                    <div class="card selection-card destination-card" data-destination="{{ dest.name|slugify }}" onclick="selectDestination({{ dest.id }}, this)">
                        <img src="{{ dest.image.url }}" class="card-img-top" alt="{{ dest.name }}">
                        <div class="card-body">
                            <h5 class="card-title">{{ dest.name }}</h5>
                            <p class="card-text">{{ dest.description }}</p>
                        </div>
                        <div class="card-footer text-center bg-light">
                            <small class="text-primary font-weight-bold">Click to explore attractions</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>

    <section class="attractions-section py-5 bg-light" id="attractions-section" style="display: none;">
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <h3 class="text-center mb-4">
                        <i class="fas fa-map-marked-alt text-primary mr-2"></i>
                        Attractions in <span id="selected-destination-name">Selected Destination</span>
                    </h3>
                    <p class="text-center text-muted mb-5">Select the attractions you'd like to visit</p>
                </div>
            </div>
            <div class="row" id="attractions-container">
            </div>
            <div class="text-center mt-4">
                <button class="btn btn-outline-secondary mr-3" onclick="backToDestinations()">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Destinations
                </button>
                <a href="{% url 'accommodation' %}" class="btn btn-primary" id="select-attractions-btn">
                    <i class="fas fa-check mr-2"></i>Continue
                </a>
            </div>
        </div>
    </section>

    {% include 'components/footer.html' %}

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // Helper function to get the CSRF token for secure POST requests
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
    
        // This function is called when a destination card is clicked
        function selectDestination(destinationId, element) {
            const container = document.getElementById('attractions-container');
            container.innerHTML = '<div class="col-12 text-center"><i class="fas fa-spinner fa-spin fa-3x"></i></div>';
    
            // Show the attractions section and scroll to it
            document.getElementById('attractions-section').style.display = 'block';
            document.getElementById('attractions-section').scrollIntoView({ behavior: 'smooth' });
    
            // Fetch attractions for the selected destination from our API
            fetch(`/api/destinations/${destinationId}/attractions/`)
                .then(response => response.json())
                .then(attractions => {
                    loadAttractions(attractions);
                });
            
            // Update the header text
            const destinationName = element.querySelector('.card-title').textContent;
            document.getElementById('selected-destination-name').textContent = destinationName;
        }
    
        // This function renders the attraction cards fetched from the API
        function loadAttractions(attractions) {
            const container = document.getElementById('attractions-container');
            container.innerHTML = ''; // Clear loading spinner
    
            if (attractions.length === 0) {
                container.innerHTML = '<div class="col-12 text-center"><p>No attractions found for this destination.</p></div>';
                return;
            }
    
            attractions.forEach(attraction => {
                const imageUrl = attraction.image_url ? attraction.image_url : "{% static 'images/placeholder.jpg' %}";
                const attractionCard = `
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card attraction-card selection-card" onclick="selectAttraction(${attraction.id}, this)">
                            <img src="${imageUrl}" class="card-img-top" alt="${attraction.name}">
                            <div class="card-body">
                                <h5 class="card-title">${attraction.name}</h5>
                                <p class="card-text">${attraction.description}</p>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += attractionCard;
            });
        }
    
        // This function is called when an attraction card is clicked
        function selectAttraction(attractionId, element) {
            fetch('/api/trip/add/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    item_type: 'attraction',
                    item_id: attractionId
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Toggle the 'selected' class for visual feedback
                    element.classList.toggle('selected');
                } else {
                    alert(data.error || 'Could not save selection. Are you logged in?');
                }
            });
        }
    
        function backToDestinations() {
            document.getElementById('attractions-section').style.display = 'none';
        }
    
        // Initialize the date picker
        flatpickr("#visit-duration", {
            mode: "range",
            dateFormat: "M j, Y",
            minDate: "today",
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    const startDate = selectedDates[0].toISOString().split('T')[0];
                    const endDate = selectedDates[1].toISOString().split('T')[0];

                    // Call the API to save the dates
                    fetch('/api/trip/dates/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken // Ensure csrftoken is defined
                        },
                        body: JSON.stringify({
                            start_date: startDate,
                            end_date: endDate
                        })
                    });
                }
            }
        });
    </script>
</body>
</html>