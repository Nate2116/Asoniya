{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .section-title { color: #333; font-weight: 600; border-bottom: 3px solid #ffc107; padding-bottom: 10px; display: inline-block; margin-bottom: 2rem; }
    .trip-total-card { border: 2px solid #ffc107; box-shadow: 0 5px 20px rgba(255,193,7,0.2); }
    .total-amount { background: linear-gradient(135deg, #ffc107, #ff9800); color: white; padding: 1rem; border-radius: 10px; }
</style>

<section class="trip-summary py-5">
    <div class="container">
        <h2 id="trip-title" class="text-center mb-4">Your Trip Summary</h2>
        <div id="summary-container"><p class="text-center">Loading your trip details...</p></div>
        <div id="action-buttons-container" class="action-buttons text-center mt-4"></div>
    </div>
</section>

{% if trip %}
<script id="trip-data" type="application/json">
{
    "trip_name": "{{ trip.name }}",
    "is_saved_trip": true,
    "start_date": "{{ trip.start_date|date:'Y-m-d' }}", "end_date": "{{ trip.end_date|date:'Y-m-d' }}",
    "duration_days": "{{ duration_days }}",
    "attractions": [
        {% for item in attractions %}
        { "name": "{{ item.name }}", "description": "{{ item.description|escapejs }}", "image_url": "{% if item.image %}{{ item.image.url }}{% endif %}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    "accommodations": [
        {% for item in accommodations %}
        { "name": "{{ item.name }}", "description": "{{ item.description|escapejs }}", "price": "{{ item.price_per_night }}", "image_url": "{% if item.image %}{{ item.image.url }}{% endif %}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    "car_rentals": [
        {% for item in car_rentals %}
        { "name": "{{ item.name }}", "description": "{{ item.description|escapejs }}", "price": "{{ item.price_per_day }}", "image_url": "{% if item.image %}{{ item.image.url }}{% endif %}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    "travel_agencies": [
        {% for item in travel_agencies %}
        { "name": "{{ item.name }}", "description": "{{ item.description|escapejs }}", "image_url": "{% if item.image %}{{ item.image.url }}{% endif %}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    "tour_packages": [
        {% for item in tour_packages %}
        { "name": "{{ item.name }}", "description": "{{ item.description|escapejs }}", "price": "{{ item.price }}", "duration_days": "{{ item.duration_days }}", "image_url": "{% if item.image %}{{ item.image.url }}{% endif %}" }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    "total_cost": "{{ total_cost|floatformat:2 }}"
}
</script>
{% endif %}

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const embeddedData = document.getElementById('trip-data');
        if (embeddedData) {
            renderTripSummary(JSON.parse(embeddedData.textContent));
        } else {
            fetch('/api/trip/summary/')
                .then(res => res.ok ? res.json() : Promise.reject(new Error('Please log in and start a trip to see your summary.')))
                .then(renderTripSummary)
                .catch(err => {
                    document.getElementById('summary-container').innerHTML = `<div class="alert alert-warning text-center">${err.message}</div>`;
                });
        }
    });

    function renderTripSummary(data) {
        const container = document.getElementById('summary-container');
        document.getElementById('trip-title').textContent = data.trip_name || 'Your Trip Summary';
        container.innerHTML = '';

        let html = '';
        const totalCost = parseFloat(data.total_cost) || 0;

        // --- Render Attractions ---
        if (data.attractions && data.attractions.length > 0) {
            html += `<div class="summary-section mb-4"><h3 class="section-title"><i class="fas fa-map-marked-alt mr-2"></i>Selected Attractions</h3><div class="row">`;
            data.attractions.forEach(item => {
                const imageUrl = item.image_url || "{% static 'images/placeholder.jpg' %}";
                html += `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card h-100">
                            <img src="${imageUrl}" class="card-img-top" alt="${item.name}" style="height: 200px; object-fit: cover;">
                            <div class="card-body">
                                <h5 class="card-title">${item.name}</h5>
                                <p class="card-text">${item.description}</p>
                            </div>
                        </div>
                    </div>`;
            });
            html += `</div></div>`;
        }

        // --- Render Other Services ---
        const services = [
            ...(data.accommodations || []), 
            ...(data.car_rentals || []), 
            ...(data.travel_agencies || []),
            ...(data.tour_packages || [])
        ];
        if (services.length > 0) {
            html += `<div class="summary-section mb-4"><h3 class="section-title"><i class="fas fa-concierge-bell mr-2"></i>Selected Services</h3><div class="row">`;
            services.forEach(item => {
                const imageUrl = item.image_url || "{% static 'images/placeholder.jpg' %}";
                const price = parseFloat(item.price || 0);
                html += `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card h-100">
                            ${price > 0 ? `<div class="card-badge">$${price.toFixed(2)}</div>` : ''}
                            <img src="${imageUrl}" class="card-img-top" alt="${item.name}" style="height: 200px; object-fit: cover;">
                            <div class="card-body">
                                <h5 class="card-title">${item.name}</h5>
                                <p class="card-text">${item.description}</p>
                            </div>
                        </div>
                    </div>`;
            });
            html += `</div></div>`;
        }

        // --- Render Cost Breakdown ---
        html += `
            <div class="summary-section mb-4">
                <h3 class="section-title"><i class="fas fa-calculator mr-2"></i>Trip Cost</h3>
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="card trip-total-card">
                            <div class="card-body text-center">
                                <div class="total-amount">
                                    <h4 class="mb-0">Total Estimated Cost: <strong>$${totalCost.toFixed(2)}</strong></h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        container.innerHTML = html;

        // --- Render Action Buttons ---
        const actionsContainer = document.getElementById('action-buttons-container');
        if (data.is_saved_trip) {
            actionsContainer.innerHTML = `<a href="{% url 'profile' %}" class="btn btn-secondary btn-lg"><i class="fas fa-arrow-left mr-2"></i>Back to Profile</a>`;
        } else {
            actionsContainer.innerHTML = `
                <div class="d-flex flex-column flex-md-row justify-content-center align-items-center" style="gap: 15px;">
                    <a href="{% url 'destinations' %}" class="btn btn-secondary btn-lg"><i class="fas fa-edit mr-2"></i>Modify Trip</a>
                    <button class="btn btn-success btn-lg" id="save-trip-btn"><i class="fas fa-save mr-2"></i>Save to Profile</button>
                </div>`;
            
            document.getElementById('save-trip-btn').addEventListener('click', function() {
                fetch('/api/trip/save/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')}
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') {
                        alert('Trip saved successfully!');
                        window.location.href = "{% url 'profile' %}";
                    } else { alert(`Error: ${data.error}`); }
                });
            });
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}