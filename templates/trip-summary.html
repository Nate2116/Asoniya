{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .section-title { color: #333; font-weight: 600; border-bottom: 3px solid #ffc107; padding-bottom: 10px; display: inline-block; margin-bottom: 2rem; }
    .trip-total-card { border: 2px solid #ffc107; box-shadow: 0 5px 20px rgba(255,193,7,0.2); }
    .total-amount { background: linear-gradient(135deg, #ffc107, #ff9800); color: white; padding: 1rem; border-radius: 10px; }
    .destination-group { margin-bottom: 2rem; }
    .destination-group-title {
        font-size: 1.8rem;
        color: #333;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 1.5rem;
    }

    /* --- New Styling for Trip Duration --- */
    .trip-duration-badge {
        display: inline-block;
        background-color: #fff8e1;
        border: 1px solid #ffc107;
        color: #856404;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 1.1rem;
        font-weight: 500;
        margin-bottom: 3rem;
    }

    /* Responsive Adjustments */
    @media (max-width: 767.98px) {
        .display-4 {
            font-size: 2.5rem;
        }
        .section-title, .destination-group-title {
            font-size: 1.5rem;
        }
        .card-title {
            font-size: 1.1rem;
        }
        .card-body {
            padding: 1rem;
        }
        .card-img-top {
            height: 150px !important;
        }
        /* --- Responsive style for duration badge --- */
        .trip-duration-badge {
            font-size: 0.95rem;
            padding: 0.4rem 0.8rem;
            margin-bottom: 2.5rem;
        }
    }
</style>

<section class="trip-summary py-5">
    <div class="container text-center">
        <h2 id="trip-title" class="mb-3 display-4">Your Trip Summary</h2>
        
        <p id="trip-duration" class="trip-duration-badge">
            {% if start_date and end_date %}
                <i class="fas fa-calendar-alt mr-2"></i>{{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }}
            {% endif %}
        </p> 
        
        <div id="summary-container"><p class="text-center">Loading your trip details...</p></div>
        <div id="action-buttons-container" class="action-buttons text-center mt-4"></div>
    </div>
</section>

{% if trip_json %}
<script id="trip-data" type="application/json">
    {{ trip_json|safe }}
</script>
{% endif %}

<script>
    function renderTripSummary(data) {
        const durationEl = document.getElementById('trip-duration');
        if (durationEl.innerHTML.trim() === '' && data.start_date && data.end_date) {
            durationEl.innerHTML = `<i class="fas fa-calendar-alt mr-2"></i> ${data.start_date} - ${data.end_date} (${data.duration_days} days)`;
        }

        const container = document.getElementById('summary-container');
        document.getElementById('trip-title').textContent = data.trip_name || 'Your Trip Summary';
        container.innerHTML = '';

        let html = '';

        if (data.destinations && data.destinations.length > 0) {
            data.destinations.forEach(dest => {
                html += `<div class="destination-group text-left">`; // Added text-left
                html += `<h3 class="destination-group-title"><i class="fas fa-map-marker-alt text-primary mr-2"></i>${dest.name}</h3>`;
                
                let contentRendered = false;
                if (dest.attractions && dest.attractions.length > 0) {
                    contentRendered = true;
                    html += `<h5>Attractions</h5><div class="row">`;
                    dest.attractions.forEach(item => {
                        html += createCard(item);
                    });
                    html += `</div>`;
                }

                if (dest.accommodations && dest.accommodations.length > 0) {
                    contentRendered = true;
                    html += `<h5 class="mt-4">Accommodations</h5><div class="row">`;
                    dest.accommodations.forEach(item => {
                        html += createCard(item);
                    });
                    html += `</div>`;
                }

                if (!contentRendered) {
                    html += `<p class="text-muted">No services selected for this destination.</p>`;
                }
                html += `</div>`;
            });
        }
        
        const services = {
            'Selected Accommodations': { items: data.accommodations, icon: 'fa-hotel' },
            'Selected Rooms': { items: data.rooms, icon: 'fa-bed' },
            'Car Rental Companies': { items: data.car_rentals, icon: 'fa-building' },
            'Selected Vehicles': { items: data.cars, icon: 'fa-car' },
            'Travel Agencies': { items: data.travel_agencies, icon: 'fa-handshake' },
            'Tour Packages': { items: data.tour_packages, icon: 'fa-suitcase-rolling' }
        };

        for (const title in services) {
            const service = services[title];
            if (service.items && service.items.length > 0) {
                html += `<div class="text-left"><h3 class="section-title"><i class="fas ${service.icon} mr-2"></i>${title}</h3></div><div class="row">`;
                service.items.forEach(item => {
                    html += createCard(item);
                });
                html += `</div>`;
            }
        }
        
        const totalCost = parseFloat(data.total_cost) || 0;
        html += `
            <div class="summary-section mb-4">
                 <div class="text-left"><h3 class="section-title"><i class="fas fa-calculator mr-2"></i>Trip Cost</h3></div>
                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <div class="card trip-total-card">
                            <div class="card-body text-center">
                                <div class="total-amount">
                                    <h4 class="mb-0">Total Estimated Cost: <strong>$${totalCost.toFixed(2)}</strong></h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        container.innerHTML = html;

        const actionsContainer = document.getElementById('action-buttons-container');
        if (data.is_saved_trip) {
            actionsContainer.innerHTML = `<a href="{% url 'profile' %}" class="btn btn-secondary btn-lg"><i class="fas fa-arrow-left mr-2"></i>Back to Profile</a>`;
        } else {
            actionsContainer.innerHTML = `
                <div class="d-flex flex-column flex-md-row justify-content-center align-items-center" style="gap: 15px;">
                    <a href="{% url 'destinations' %}" class="btn btn-secondary btn-lg"><i class="fas fa-edit mr-2"></i>Modify Trip</a>
                    <button class="btn btn-success btn-lg" id="save-trip-btn"><i class="fas fa-save mr-2"></i>Save to Profile</button>
                </div>`;
            
            document.getElementById('save-trip-btn').addEventListener('click', function() {
                fetch('/api/trip/save/', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')}
                }).then(res => res.json()).then(data => {
                    if (data.status === 'success') {
                        window.location.href = "{% url 'profile' %}";
                    } else { 
                        alert(`Error: ${data.error}`); 
                    }
                });
            });
        }
    }

    function createCard(item) {
        const imageUrl = item.image_url || "{% static 'images/placeholder.jpg' %}";
        const price = parseFloat(item.price || 0);
        return `
            <div class="col-6 col-md-6 col-lg-4 mb-4">
                <div class="card h-100 text-left">
                    ${price > 0 ? `<div class="card-badge">$${price.toFixed(2)}</div>` : ''}
                    <img src="${imageUrl}" class="card-img-top" alt="${item.name}" style="height: 200px; object-fit: cover;">
                    <div class="card-body">
                        <h5 class="card-title">${item.name}</h5>
                        <p class="card-text d-none d-md-block">${item.description}</p>
                    </div>
                </div>
            </div>`;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const embeddedData = document.getElementById('trip-data');
        if (embeddedData) {
            renderTripSummary(JSON.parse(embeddedData.textContent));
        } else {
            fetch('/api/trip/summary/')
                .then(res => res.ok ? res.json() : Promise.reject(new Error('Please log in and start a trip to see your summary.')))
                .then(renderTripSummary)
                .catch(err => {
                    document.getElementById('summary-container').innerHTML = `<div class="alert alert-warning text-center">${err.message}</div>`;
                });
        }
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}