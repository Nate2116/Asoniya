{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .profile-section {
        padding: 40px 0;
        background-color: #f8f9fa;
    }
    .profile-card {
        background-color: #fff;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 25px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .profile-card h3 {
        margin-bottom: 20px;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        color: #333;
    }
    .info-item {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    .list-group-item {
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    .list-group-item:hover {
        transform: translateX(5px);
        background-color: #f8f9fa;
    }
</style>

<section class="profile-section">
    <div class="container">
        <h2 class="text-center mb-5">My Profile</h2>
        
        <div class="profile-card">
            <h3><i class="fas fa-user mr-2"></i> Personal Information</h3>
            <div id="personal-info-content">
                <div class="info-item">
                    <strong>Full Name:</strong> <span id="user-fullname">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Email:</strong> <span id="user-email">Loading...</span>
                </div>
            </div>
        </div>

        <div class="profile-card">
            <h3><i class="fas fa-suitcase mr-2"></i> Saved Trips</h3>
            <div id="saved-trips-list" class="list-group">
                <p>Loading your saved trips...</p>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const csrftoken = getCookie('csrftoken'); // Assuming getCookie is available from base.html or header

        // Fetch and display user's personal information
        fetch('/api/profile/', {
            headers: { 'X-CSRFToken': csrftoken }
        })
        .then(response => {
            if (!response.ok) throw new Error('Not logged in');
            return response.json();
        })
        .then(data => {
            const fullName = `${data.first_name || ''} ${data.last_name || ''}`.trim() || data.username;
            document.getElementById('user-fullname').textContent = fullName;
            document.getElementById('user-email').textContent = data.email;
        })
        .catch(error => {
            const infoContent = document.getElementById('personal-info-content');
            infoContent.innerHTML = `<p class="text-muted">Please <a href="{% url 'login' %}">log in</a> to view your profile.</p>`;
        });
        
        // Fetch and display saved trips
        fetch('/api/trip/summary/', {
            headers: { 'X-CSRFToken': csrftoken }
        })
        .then(response => {
            if (!response.ok) throw new Error('No trips found');
            return response.json();
        })
        .then(data => {
            const tripsList = document.getElementById('saved-trips-list');
            tripsList.innerHTML = ''; // Clear the "Loading..." message

            // We will display attractions as a proxy for a trip
            if (data.attractions && data.attractions.length > 0) {
                const tripName = `My Trip with ${data.attractions.length} attraction(s)`;
                const tripDetails = data.attractions.map(attr => attr.name).join(', ');

                const tripItem = `
                    <a href="{% url 'trip_summary' %}" class="list-group-item list-group-item-action">
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${tripName}</h5>
                            <small>View Details</small>
                        </div>
                        <p class="mb-1">Featuring: ${tripDetails}</p>
                    </a>`;
                tripsList.innerHTML = tripItem;
            } else {
                tripsList.innerHTML = '<p class="text-muted">You have no saved trips. Start planning one from the <a href="{% url 'destinations' %}">destinations page</a>!</p>';
            }
        })
        .catch(error => {
            const tripsList = document.getElementById('saved-trips-list');
            tripsList.innerHTML = '<p class="text-muted">Could not load saved trips. Please try again later.</p>';
        });
    });

    // CSRF Token helper function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}