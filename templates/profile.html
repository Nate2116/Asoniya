{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    .profile-section {
        padding: 40px 0;
        background-color: #f8f9fa;
    }
    .profile-card {
        background-color: #fff;
        padding: 25px;
        border-radius: 8px;
        margin-bottom: 25px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .profile-card h3 {
        margin-bottom: 20px;
        border-bottom: 2px solid #ffc107;
        padding-bottom: 10px;
        color: #333;
    }
    .info-item {
        font-size: 1.1rem;
        margin-bottom: 15px;
    }
    .list-group-item {
        border-radius: 8px;
        margin-bottom: 10px;
        transition: all 0.3s ease;
    }
    .list-group-item:hover {
        transform: translateX(5px);
        background-color: #f8f9fa;
    }
</style>

<section class="profile-section">
    <div class="container">
        <h2 class="text-center mb-5">My Profile</h2>
        
        <div class="profile-card">
            <h3><i class="fas fa-user mr-2"></i> Personal Information</h3>
            <div id="personal-info-content">
                <div class="info-item">
                    <strong>Full Name:</strong> <span id="user-fullname">Loading...</span>
                </div>
                <div class="info-item">
                    <strong>Email:</strong> <span id="user-email">Loading...</span>
                </div>
            </div>
        </div>

        <div class="profile-card">
            <h3><i class="fas fa-suitcase mr-2"></i> Saved Trips</h3>
            <div id="saved-trips-list" class="list-group">
                <p>Loading your saved trips...</p>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Make just one API call to get all profile data
        fetch('/api/profile/')
            .then(response => {
                if (!response.ok) {
                    // This will trigger if the user is not logged in
                    throw new Error('Please log in to view your profile.');
                }
                return response.json();
            })
            .then(data => {
                // --- Populate Personal Info ---
                const fullName = `${data.first_name || ''} ${data.last_name || ''}`.trim() || data.username;
                document.getElementById('user-fullname').textContent = fullName;
                document.getElementById('user-email').textContent = data.email;

                // --- Populate Saved Trips ---
                const tripsList = document.getElementById('saved-trips-list');
                tripsList.innerHTML = ''; // Clear the "Loading..." message

                if (data.saved_trips && data.saved_trips.length > 0) {
                    data.saved_trips.forEach(trip => {
                        const tripItemHTML = `
                            <a href="${trip.view_url}" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h5 class="mb-1">${trip.name}</h5>
                                    <small>${trip.item_count} items</small>
                                </div>
                                <p class="mb-1">Click to view this trip summary.</p>
                            </a>`;
                        tripsList.innerHTML += tripItemHTML;
                    });
                } else {
                    tripsList.innerHTML = '<p class="text-muted">You have no saved trips. Start planning one from the <a href="{% url 'destinations' %}">destinations page</a>!</p>';
                }
            })
            .catch(error => {
                // This block will handle errors, including the "Not logged in" case
                const profileContainer = document.querySelector('.profile-section .container');
                profileContainer.innerHTML = `<div class="alert alert-warning text-center">${error.message}</div>`;
            });
        
    });
</script>
{% endblock %}