{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
    /* --- New Accommodation Card Styling --- */
    .accommodation-section {
        background-color: #f8f9ff;
    }

    .accommodation-card {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        position: relative;
        border: none;
         display: flex; /* Added for flex layout */
        flex-direction: column; /* Ensures vertical layout */
        height: 100%; /* Ensures cards in a row are the same height */
    }

    .accommodation-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }

    .card-image-top {
        height: 250px;
        background-size: cover;
        background-position: center;
    }
    
    .card-content {
        padding: 1.5rem;
        flex-grow: 1; /* Allows this section to grow */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* Pushes footer to the bottom */
    }

    .card-type {
        color: #ffc107; /* Matches project's primary color */
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 1px;
    }

    .card-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        color: #333;
    }

    .card-description {
        color: #666;
        margin-bottom: 1.5rem;
        line-height: 1.6;
        min-height: 70px; /* Ensures consistent card height */
    }

    .services-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        min-height: 50px; /* Ensures consistent card height */
    }

    .service-tag {
        background: #fff8e1; /* Lighter shade of the primary color */
        color: #856404;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .card-footer-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-top: 1px solid #eee;
        padding-top: 1rem;
        margin-top: auto; /* Pushes footer to the bottom */
    }

    .view-details-btn {
        background: #ffc107; /* Matches project's primary color */
        color: #333;
        border: none;
        padding: 0.6rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .view-details-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
    }
    
    /* --- New Filter Styling --- */
    .filters-section {
        background-color: #ffffff;
        padding: 2rem 0;
        border-bottom: 1px solid #f0f0f0;
    }
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        align-items: center;
    }
    .filter-group {
        display: flex;
        flex-direction: column;
    }
    .filter-group label {
        font-weight: 600;
        color: #555;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    .filter-group .form-control, .filter-group .btn {
        border-radius: 8px;
        border: 1px solid #ddd;
    }
</style>

<section class="page-header bg-light py-5">
    <div class="container">
        <div class="text-center">
            <h1 class="display-4 mb-3">Accommodation</h1>
            <p class="lead">Find the perfect place to stay during your Ethiopian adventure</p>
        </div>
    </div>
</section>

<section class="filters-section">
    <div class="container">
        <div class="filter-grid">
            <div class="filter-group">
                <label for="filter-destination"><i class="fas fa-map-marker-alt mr-1"></i> Destination</label>
                <select class="form-control" id="filter-destination">
                    <option value="">All Destinations</option>
                    {% for dest in destinations %}
                        <option value="{{ dest.id }}">{{ dest.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label for="filter-type"><i class="fas fa-building mr-1"></i> Accommodation Type</label>
                <select class="form-control" id="filter-type">
                    <option value="">All Types</option>
                    <option value="Hotel">Hotel</option>
                    <option value="Resort">Resort</option>
                    <option value="Lodge">Lodge</option>
                </select>
            </div>
            <div class="filter-group">
                <button class="btn btn-primary w-100" id="apply-filters-btn">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>
</section>

<section class="accommodations-section py-5">
    <div class="container">
        <div class="row" id="accommodation-list">
            </div>
    </div>
</section>

<section class="navigation-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="progress-container">
                    <div class="progress-info">
                        <h6>Trip Planning Progress</h6>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="progress-step">Step 2 of 4: Accommodation</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-right navigation-buttons">
                <a href="{% url 'destinations' %}" class="btn btn-outline-secondary mr-2">
                    <i class="fas fa-arrow-left mr-1"></i>Back
                </a>
                <a href="{% url 'travel_agencies' %}" class="btn btn-primary">
                    Next <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
        </div>
    </div>
</section>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    function fetchAndRenderAccommodations(url = '/api/accommodations/') {
        fetch(url)
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('accommodation-list');
                list.innerHTML = ''; 

                if (data.length === 0) {
                    list.innerHTML = '<div class="col-12 text-center"><p>No accommodations found matching your criteria.</p></div>';
                    return;
                }

                data.forEach(acc => {
                    const imageUrl = acc.image_url ? acc.image_url : "{% static 'images/placeholder.jpg' %}";
                    const detailUrl = `/accommodation/${acc.id}/`;
                    
                    const amenitiesHtml = acc.amenities.slice(0, 4).map(amenity => `<span class="service-tag">${amenity}</span>`).join('');

                     const card = `
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="accommodation-card">
                                <div class="card-image-top" style="background-image: url('${imageUrl}')"></div>
                                <div class="card-content">
                                    <div>
                                        <div class="card-type">${acc.accommodation_type}</div>
                                        <h3 class="card-title">${acc.name}</h3>
                                        <p class="card-description">${acc.description.substring(0, 100)}...</p>
                                        <div class="services-list">
                                            ${amenitiesHtml}
                                        </div>
                                    </div>
                                    <div class="card-footer-custom">
                                        <a href="${detailUrl}" class="view-details-btn">View Details</a>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    list.innerHTML += card;
                });
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetchAndRenderAccommodations();

        document.getElementById('apply-filters-btn').addEventListener('click', function() {
            const destination = document.getElementById('filter-destination').value;
            const type = document.getElementById('filter-type').value;
            
            const params = new URLSearchParams();
            if (destination) params.append('destination', destination);
            if (type) params.append('type', type);

            fetchAndRenderAccommodations(`/api/accommodations/?${params.toString()}`);
        });
    });
</script>
{% endblock %}